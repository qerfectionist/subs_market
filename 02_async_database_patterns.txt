TITLE: SQLAlchemy 2.0 Async Patterns
CONTEXT: Работа с БД PostgreSQL + SQLAlchemy (asyncpg) для Telegram ботов.

1. ENGINE & SESSION
Драйвер соединения: `postgresql+asyncpg://...`
Используй `create_async_engine` и `async_sessionmaker`.

2. MODELS (DeclarativeBase)
Используй современный стиль (Mapped, mapped_column).
class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(primary_key=True)
    username: Mapped[str | None]

3. QUERIES (Запросы)
Запрещены методы `.query()` (это старый стиль). Используй `select()`, `update()`.
Пример выборки:
stmt = select(User).where(User.id == user_id)
result = await session.execute(stmt)
user = result.scalar_one_or_none()

4. MIDDLEWARE INJECTION
Сессия БД не создается внутри хендлера. Она прокидывается через Middleware.
async def db_session_middleware(handler, event, data):
    async with session_maker() as session:
        data['session'] = session
        return await handler(event, data)