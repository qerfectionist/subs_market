TITLE: Aiogram 3.x Best Practices & Architecture
CONTEXT: Гайдлайн по написанию кода на Python для Telegram ботов (aiogram 3.x).

1. ROUTERS (Роутеры)
Вместо Dispatcher в каждом файле используем Router.
Пример:
from aiogram import Router
router = Router()
@router.message()
async def handler(...)

2. MAGIC FILTERS (Магические фильтры)
Вместо lambda функций используй F.
- ПЛОХО: lambda c: c.data == 'yes'
- ХОРОШО: F.data == 'yes'
- ХОРОШО: F.text.startswith("/")
- ХОРОШО: F.content_type.in_({'photo', 'video'})

3. CALLBACK DATA FACTORY
Не используй сырые строки ("buy_123"). Используй типизированные объекты.
from aiogram.filters.callback_data import CallbackData
class MenuCB(CallbackData, prefix="menu"):
    action: str
    id: int
# В хендлере:
@router.callback_query(MenuCB.filter(F.action == "open"))
async def handler(query: CallbackQuery, callback_data: MenuCB):
    item_id = callback_data.id

4. KEYBOARDS (Клавиатуры)
Используй `InlineKeyboardBuilder` вместо ручного создания матриц кнопок.
builder = InlineKeyboardBuilder()
builder.button(text="Купить", callback_data="buy")
builder.adjust(2) # Кнопок в ряду
return builder.as_markup()